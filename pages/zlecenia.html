<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktualne zlecenia ‚Äî ZLECAJ z LUMENA</title>

  <!-- SEO -->
  <meta name="description" content="PrzeglƒÖdaj najnowsze zlecenia remontowe, budowlane i projektowe. Filtruj po kategorii, lokalizacji i sortuj po dacie.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="canonical" href="https://zlecajzlumena.pl/pages/zlecenia.html" />

  <!-- Favicon -->
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="wrap flex between center-v">
      <a href="/" class="logo">
        <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA" height="60" />
      </a>
      <nav class="nav">
        <a href="/pages/panel-firma.html">Panel firmy</a>
        <button id="logoutBtn" class="cta secondary">Wyloguj siƒô</button>
      </nav>
    </div>
  </header>

  <!-- POWITANIE -->
  <section class="welcome-bar center" id="welcomeBox" style="padding: 10px 0; color: var(--gold); font-weight: 500;"></section>

  <!-- LISTA ZLECE≈É -->
  <section class="zlecenia-list">
    <div class="wrap">
      <h1 id="pageTitle">Aktualne zlecenia</h1>
      <p id="pageSubtitle" class="subtitle">PrzeglƒÖdaj najnowsze zlecenia dodane przez klient√≥w üíé</p>

      <!-- FILTRY -->
      <form id="filterForm" class="filters">
        <div class="filter-group">
          <label for="miasto">Miasto</label>
          <input type="text" id="miasto" placeholder="np. Warszawa">
        </div>

        <div class="filter-group">
          <label for="kategoria">Kategoria</label>
          <select id="kategoria">
            <option value="">Wszystkie</option>
            <option value="Remonty i budowa">Remonty i budowa</option>
            <option value="Wyko≈Ñczenia wnƒôtrz">Wyko≈Ñczenia wnƒôtrz</option>
            <option value="Ogr√≥d i zewnƒôtrza">Ogr√≥d i zewnƒôtrza</option>
            <option value="Us≈Çugi projektowe">Us≈Çugi projektowe</option>
            <option value="Transport i przeprowadzki">Transport i przeprowadzki</option>
            <option value="Inne">Inne</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="sort">Sortuj</label>
          <select id="sort">
            <option value="desc">Najnowsze</option>
            <option value="asc">Najstarsze</option>
          </select>
        </div>

        <button type="submit" class="cta small">Filtruj</button>
      </form>

      <!-- ZLECENIA -->
      <div id="zleceniaContainer" class="zlecenia-grid">
        <p>≈Åadowanie zlece≈Ñ...</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="wrap foot">
      <div>
        <h5>Sekcje</h5>
        <a href="/pages/oferty.html">Oferty</a>
        <a href="/pages/rejestracja.html">Rejestracja</a>
        <a href="/pages/login.html">Logowanie</a>
      </div>
      <div>
        <h5>Informacje</h5>
        <a href="/pages/o-lumena.html">O LUMENA</a>
        <a href="/pages/polityka.html">Polityka prywatno≈õci</a>
        <a href="/pages/rodo.html">RODO</a>
        <a href="/pages/regulamin.html">Regulamin</a>
        <a href="/pages/cookies.html">Polityka cookies</a>
        <a href="/pages/bezpieczenstwo.html">Poradnik bezpiecze≈Ñstwa</a>
      </div>
      <div>
        <h5>Kontakt</h5>
        <a href="mailto:kontakt.lumena.studio@gmail.com">kontakt.lumena.studio@gmail.com</a>
        <a href="#">Instagram</a>
        <a href="#">Pinterest</a>
      </div>
    </div>

    <div class="copy">
      ¬© 2025 <span class="gold">LUMENA Creative</span> üíé  
      <br><small>Wszystkie prawa zastrze≈ºone.</small>
    </div>
  </footer>

  <!-- üîê DOSTƒòP + FIREBASE -->
  <script type="module">
    // üîí Sprawdzenie zalogowania i typu u≈ºytkownika
    const token = localStorage.getItem("lumena_user_token");
    const userType = localStorage.getItem("userType");
    const email = localStorage.getItem("userEmail") || "";

    if (!token || userType !== "company") {
      alert("Ta sekcja jest dostƒôpna tylko dla zalogowanych firm üíº");
      window.location.href = "/pages/login.html";
    }

    // Wy≈õwietl powitanie
    const welcomeBox = document.getElementById("welcomeBox");
    if (email) {
      welcomeBox.innerHTML = `üëã Zalogowano jako <strong>${email}</strong> ‚Ä¢ Mo≈ºesz przeglƒÖdaƒá zlecenia i sk≈Çadaƒá oferty üíé`;
    }

    // Obs≈Çuga wylogowania
    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      if (confirm("Czy na pewno chcesz siƒô wylogowaƒá?")) {
        localStorage.removeItem("lumena_user_token");
        localStorage.removeItem("userType");
        localStorage.removeItem("userEmail");
        window.location.href = "/pages/login.html";
      }
    });

    // üß± FIREBASE
    import { db } from "/js/firebase.js";
    import { collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const container = document.getElementById("zleceniaContainer");
    const titleEl = document.getElementById("pageTitle");
    const subtitleEl = document.getElementById("pageSubtitle");
    const form = document.getElementById("filterForm");
    const cityInput = document.getElementById("miasto");
    const categorySelect = document.getElementById("kategoria");
    const sortSelect = document.getElementById("sort");

    // Pobierz kategoriƒô z parametru URL
    const params = new URLSearchParams(window.location.search);
    const categoryParam = params.get("kategoria");
    if (categoryParam) {
      categorySelect.value = categoryParam;
      titleEl.textContent = `Zlecenia: ${categoryParam}`;
      subtitleEl.textContent = `PrzeglƒÖdaj zlecenia w kategorii ‚Äû${categoryParam}‚Äù üíé`;
    }

    async function loadZlecenia() {
      try {
        container.innerHTML = "<p>≈Åadowanie zlece≈Ñ...</p>";
        const colRef = collection(db, "zlecenia");
        const filters = [];

        const selectedCategory = categorySelect.value;
        const selectedCity = cityInput.value.trim();
        const sortOrder = sortSelect.value;

        if (selectedCategory) filters.push(where("kategoria", "==", selectedCategory));
        if (selectedCity) filters.push(where("miasto", "==", selectedCity));

        let q;
        if (filters.length > 0) {
          q = query(colRef, ...filters, orderBy("createdAt", sortOrder));
        } else {
          q = query(colRef, orderBy("createdAt", sortOrder));
        }

        const snapshot = await getDocs(q);
        container.innerHTML = "";

        if (snapshot.empty) {
          container.innerHTML = `<p>Brak zlece≈Ñ spe≈ÇniajƒÖcych wybrane kryteria.</p>`;
          return;
        }

        let counter = 0;
        snapshot.forEach(docSnap => {
          const z = docSnap.data();
          const id = docSnap.id;
          const card = document.createElement("div");
          card.className = "zlecenie-card";
          card.innerHTML = `
            <h3>${z.tytul}</h3>
            <p class="meta">${z.miasto || "‚Äî"} ‚Ä¢ dodano: ${
              z.createdAt?.toDate ? z.createdAt.toDate().toLocaleDateString("pl-PL") : "‚Äî"
            }</p>
            <p class="desc">${z.opis || ""}</p>
            <div class="order-actions">
              <a href="/pages/szczegoly-zlecenia.html?id=${id}" class="cta secondary">Zobacz szczeg√≥≈Çy</a>
              <a href="/pages/szczegoly-zlecenia.html?id=${id}#zloz-oferte" class="cta">Z≈Ç√≥≈º ofertƒô</a>
            </div>
          `;
          container.appendChild(card);

          counter++;
          if (counter % 3 === 0) {
            const ad = document.createElement("div");
            ad.className = "ad-placeholder";
            ad.textContent = "üíé Miejsce na reklamƒô partnera";
            container.appendChild(ad);
          }
        });
      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd ≈Çadowania zlece≈Ñ:", err);
        container.innerHTML = `<p>Nie uda≈Ço siƒô za≈Çadowaƒá zlece≈Ñ. Spr√≥buj ponownie.</p>`;
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      loadZlecenia();
    });

    loadZlecenia();
  </script>

  <!-- üíé STYL REKLAM -->
  <style>
    .ad-placeholder {
      background: rgba(255,255,255,0.05);
      border: 1px dashed rgba(255,255,255,0.2);
      color: var(--gold);
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      font-size: 14px;
      margin: 20px auto;
    }
  </style>
</body>
</html>
