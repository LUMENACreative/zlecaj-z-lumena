<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Klienta â€” ZLECAJ z LUMENA</title>

  <!-- SEO -->
  <meta name="description" content="TwÃ³j panel klienta â€” zarzÄ…dzaj zleceniami, kontaktuj siÄ™ z wykonawcami i dodawaj nowe projekty. ZLECAJ z LUMENA.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="canonical" href="https://zlecajzlumena.pl/pages/panel-klient.html" />

  <!-- Favicon -->
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER â€” PANEL KLIENTA -->
  <header class="topbar panel-header">
    <div class="wrap flex between center-v">
      <div class="logo-area flex center-v">
        <a href="/" class="logo">
          <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA logo" height="64" />
        </a>
        <span class="panel-title">Panel Klienta</span>
      </div>

      <nav class="panel-nav flex center-v">
        <a href="/pages/dodaj-zlecenie.html" class="cta">Dodaj zlecenie</a>
        <button id="logoutBtn" class="cta secondary">Wyloguj siÄ™</button>
      </nav>
    </div>
  </header>

  <!-- PANEL KLIENTA -->
  <section class="panel">
    <div class="wrap">
      <h1 id="welcomeText">Witaj ğŸ’</h1>
      <p class="subtitle">ZarzÄ…dzaj swoimi zleceniami, opiniami i profilem.</p>

      <!-- Akcje szybkie -->
      <div class="panel-actions center">
        <a href="/pages/dodaj-zlecenie.html" class="cta">+ Dodaj nowe zlecenie</a>
      </div>

      <!-- Nawigacja zakÅ‚adek -->
      <div class="admin-tabs-nav center" style="margin:24px 0;">
        <button class="tab-btn cta secondary active" data-tab="zleceniaTab">ğŸ§¾ Moje zlecenia</button>
        <button class="tab-btn cta secondary" data-tab="opinieTab">ğŸ’ Moje opinie</button>
        <button class="tab-btn cta secondary" data-tab="statystykiTab">ğŸ“Š Statystyki</button>
      </div>

      <!-- ZawartoÅ›Ä‡ zakÅ‚adek -->
      <div class="admin-tabs">

        <!-- ğŸ§¾ MOJE ZLECENIA -->
        <div id="zleceniaTab" class="tab-pane active fade">
          <h2 class="section-title">Twoje zlecenia</h2>
          <div id="ordersList" class="orders">
            <p>Åadowanie Twoich zleceÅ„...</p>
          </div>
        </div>

        <!-- ğŸ’ MOJE OPINIE -->
        <div id="opinieTab" class="tab-pane fade">
          <div class="admin-card">
            <h2>Twoje opinie o firmach</h2>
            <p class="muted" style="margin-bottom:12px">Opinie sÄ… posortowane od najnowszych.</p>
            <div id="opinieListUser" class="admin-list">
              <p>Åadowanie Twoich opinii...</p>
            </div>
          </div>
        </div>

        <!-- ğŸ“Š STATYSTYKI -->
        <div id="statystykiTab" class="tab-pane fade">
          <div class="admin-card">
            <h2>Statystyki konta</h2>
            <div class="grid-3">
              <div class="card-stats">
                <div class="icon">ğŸ§¾</div>
                <h3 id="statZlecenia">0</h3>
                <p>Dodane zlecenia</p>
              </div>
              <div class="card-stats">
                <div class="icon">ğŸ’</div>
                <h3 id="statOpinie">0</h3>
                <p>Wystawione opinie</p>
              </div>
              <div class="card-stats">
                <div class="icon">ğŸ“…</div>
                <h3 id="statData">-</h3>
                <p>Data rejestracji</p>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /admin-tabs -->
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="wrap foot">
      <div>
        <h5>Sekcje</h5>
        <a href="/pages/oferty.html">Zlecenia</a>
        <a href="/pages/rejestracja.html">Rejestracja</a>
        <a href="/pages/login.html">Logowanie</a>
      </div>
      <div>
        <h5>Informacje</h5>
        <a href="/pages/o-lumena.html">O LUMENA</a>
        <a href="/pages/polityka.html">Polityka prywatnoÅ›ci</a>
        <a href="/pages/rodo.html">RODO</a>
        <a href="/pages/bezpieczenstwo.html">Poradnik bezpieczeÅ„stwa</a>
      </div>
      <div>
        <h5>Kontakt</h5>
        <a href="mailto:kontakt.lumena.studio@gmail.com">kontakt.lumena.studio@gmail.com</a>
        <a href="#">Instagram</a>
        <a href="#">Pinterest</a>
      </div>
    </div>
    <div class="copy">
      Â© 2025 <span class="gold">LUMENA Creative</span> ğŸ’  
      <br><small>Wszystkie prawa zastrzeÅ¼one.</small>
    </div>
  </footer>

  <!-- ğŸ”¥ FIREBASE PANEL KLIENTA -->
  <script type="module">
    import { db } from "/js/firebase.js";
    import {
      collection, query, where, getDocs, doc, deleteDoc,
      orderBy, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const ordersList = document.getElementById("ordersList");
    const welcomeText = document.getElementById("welcomeText");
    const logoutBtn = document.getElementById("logoutBtn");

    // ğŸ” Weryfikacja dostÄ™pu (akceptujemy TwÃ³j stary token lub nowe flagi)
    const token = localStorage.getItem("lumena_user_token");
    const loggedIn = localStorage.getItem("loggedIn");
    const userType = localStorage.getItem("userType");
    const userEmail = localStorage.getItem("userEmail");

    if ((!token && !loggedIn) || userType !== "client") {
      alert("DostÄ™p tylko dla zalogowanych klientÃ³w ğŸ’");
      window.location.href = "/pages/login.html";
    }

    // Powitanie
    welcomeText.textContent = `Witaj ${userEmail || "kliencie"} ğŸ’`;

    // ===== Tabs
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanes   = document.querySelectorAll(".tab-pane");
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        tabPanes.forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        const pane = document.getElementById(btn.dataset.tab);
        pane.classList.add("active");
        // animacja fade-in
        setTimeout(() => pane.classList.add("visible"), 50);
      });
    });

    // ğŸšª Wylogowanie
    logoutBtn.addEventListener("click", () => {
      if (confirm("Czy chcesz siÄ™ wylogowaÄ‡?")) {
        localStorage.clear();
        window.location.href = "/pages/login.html";
      }
    });

    // ğŸ§¾ Pobieranie zleceÅ„ przypisanych do uÅ¼ytkownika (od najnowszych)
    async function loadUserOrders() {
      try {
        const qRef = query(
          collection(db, "zlecenia"),
          where("autorEmail", "==", userEmail),
          orderBy("createdAt", "desc")
        );

        const snapshot = await getDocs(qRef);
        ordersList.innerHTML = "";

        if (snapshot.empty) {
          ordersList.innerHTML = "<p>Nie masz jeszcze Å¼adnych zleceÅ„. Dodaj pierwsze ğŸ’</p>";
          document.getElementById("statZlecenia").textContent = "0";
          return;
        }

        let count = 0;
        snapshot.forEach((docSnap) => {
          count++;
          const z = docSnap.data();
          const div = document.createElement("div");
          div.classList.add("order-card");
          const dateStr = z.createdAt?.toDate ? z.createdAt.toDate().toLocaleDateString("pl-PL") : "";
          div.innerHTML = `
            <h3>${z.tytul || "Bez tytuÅ‚u"}</h3>
            <p class="meta">${z.miasto || "Brak lokalizacji"} â€¢ ${dateStr}</p>
            <p class="desc">${z.opis || ""}</p>
            <div class="order-actions">
              <a href="/pages/szczegoly-zlecenia.html?id=${docSnap.id}" class="cta secondary">Zobacz szczegÃ³Å‚y</a>
              <button class="cta delete-btn" data-id="${docSnap.id}">UsuÅ„</button>
            </div>
          `;
          ordersList.appendChild(div);
        });
        document.getElementById("statZlecenia").textContent = String(count);
      } catch (err) {
        console.error("BÅ‚Ä…d pobierania zleceÅ„:", err);
        ordersList.innerHTML = "<p>âŒ WystÄ…piÅ‚ bÅ‚Ä…d przy pobieraniu Twoich zleceÅ„.</p>";
      }
    }

    // ğŸ—‘ï¸ Usuwanie zlecenia
    ordersList.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        if (confirm("Czy na pewno chcesz usunÄ…Ä‡ to zlecenie?")) {
          await deleteDoc(doc(db, "zlecenia", id));
          alert("Zlecenie zostaÅ‚o usuniÄ™te ğŸ—‘ï¸");
          loadUserOrders();
        }
      }
    });

    // ğŸ’ Moje opinie (od najnowszych) â€” edycja i usuwanie
    const opinieListUser = document.getElementById("opinieListUser");

    async function loadUserOpinions() {
      try {
        const qRef = query(
          collection(db, "opinie"),
          where("autorEmail", "==", userEmail),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qRef);

        opinieListUser.innerHTML = "";

        if (snap.empty) {
          opinieListUser.innerHTML = "<p>Nie masz jeszcze Å¼adnych opinii. Napisz pierwszÄ… po skorzystaniu z usÅ‚ugi ğŸ’</p>";
          document.getElementById("statOpinie").textContent = "0";
          return;
        }

        let count = 0;
        const container = document.createElement("div");
        container.classList.add("admin-grid");

        for (const d of snap.docs) {
          count++;
          const o = d.data();
          const id = d.id;
          const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString("pl-PL") : "";
          const ocena = o.ocena || 0;
          let diamonds = "";
          for (let i = 1; i <= 5; i++) diamonds += i <= ocena ? "ğŸ’" : "â—‡";

          const card = document.createElement("div");
          card.classList.add("admin-card-row");
          card.innerHTML = `
            <div class="row-main">
              <div class="row-head">
                <strong class="gold">${o.firmName || o.firmEmail || "Firma"}</strong>
                <span class="diamonds">${diamonds}</span>
              </div>
              <div class="row-meta">
                <span class="muted">${dateStr}</span>
                ${o.firmEmail ? `<span class="muted">${o.firmEmail}</span>` : ""}
              </div>
              <p class="row-desc">${o.tresc || ""}</p>
            </div>
            <div class="row-actions">
              <button class="cta small secondary edit-opinia" data-id="${id}" data-ocena="${ocena}" data-tresc="${encodeURIComponent(o.tresc || "")}">Edytuj</button>
              <button class="cta small secondary delete-opinia" data-id="${id}">UsuÅ„</button>
            </div>
          `;
          container.appendChild(card);
        }

        opinieListUser.appendChild(container);
        document.getElementById("statOpinie").textContent = String(count);
      } catch (err) {
        console.error("BÅ‚Ä…d pobierania opinii:", err);
        opinieListUser.innerHTML = "<p>âŒ WystÄ…piÅ‚ bÅ‚Ä…d podczas pobierania Twoich opinii.</p>";
      }
    }

    // Edycja/Usuwanie opinii â€” obsÅ‚uga klikniÄ™Ä‡ (delegacja)
    opinieListUser.addEventListener("click", async (e) => {
      const target = e.target;

      // UsuÅ„ opiniÄ™
      if (target.classList.contains("delete-opinia")) {
        const id = target.dataset.id;
        if (!id) return;
        if (confirm("UsunÄ…Ä‡ tÄ™ opiniÄ™? Tej operacji nie moÅ¼na cofnÄ…Ä‡.")) {
          try {
            await deleteDoc(doc(db, "opinie", id));
            loadUserOpinions();
          } catch (err) {
            console.error("BÅ‚Ä…d usuwania opinii:", err);
            alert("Nie udaÅ‚o siÄ™ usunÄ…Ä‡ opinii.");
          }
        }
      }

      // Edytuj opiniÄ™
      if (target.classList.contains("edit-opinia")) {
        const id = target.dataset.id;
        const currentOcena = Number(target.dataset.ocena || 0);
        const currentTresc = decodeURIComponent(target.dataset.tresc || "");

        openEditOpinionModal(id, currentOcena, currentTresc);
      }
    });

    // ğŸ“Š Statystyki â€” data rejestracji z kolekcji "uzytkownicy"
    async function loadStatsDate() {
      try {
        // Szukamy po e-mailu (zgodnie z TwojÄ… rejestracjÄ… klienta)
        const qRef = query(collection(db, "uzytkownicy"), where("email", "==", userEmail));
        const snap = await getDocs(qRef);
        if (!snap.empty) {
          const data = snap.docs[0].data();
          const dateStr = data.dataRejestracji
            ? new Date(data.dataRejestracji).toLocaleDateString("pl-PL")
            : "-";
          document.getElementById("statData").textContent = dateStr;
        } else {
          document.getElementById("statData").textContent = "-";
        }
      } catch (err) {
        console.warn("Nie udaÅ‚o siÄ™ pobraÄ‡ daty rejestracji:", err);
      }
    }

    // ===== Modal edycji opinii (prosty, bez zewnÄ™trznych CSS)
    function openEditOpinionModal(id, ocena, tresc) {
      const modal = document.createElement("div");
      modal.className = "opinion-modal";
      modal.innerHTML = `
        <div class="opinion-modal-content">
          <h3>Edytuj opiniÄ™</h3>
          <div class="rating-row" id="ratingRow">
            ${[1,2,3,4,5].map(i => `<span class="diamond ${i<=ocena?"active":""}" data-val="${i}">ğŸ’</span>`).join("")}
          </div>
          <textarea id="opinionText" rows="4" placeholder="TreÅ›Ä‡ opinii...">${tresc || ""}</textarea>
          <div class="modal-actions">
            <button class="cta secondary" id="cancelEdit">Anuluj</button>
            <button class="cta" id="saveEdit">Zapisz</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      let chosen = ocena || 0;
      modal.querySelectorAll(".diamond").forEach(d => {
        d.addEventListener("click", () => {
          chosen = Number(d.dataset.val);
          modal.querySelectorAll(".diamond").forEach(x => x.classList.remove("active"));
          for (let i=0; i<chosen; i++) modal.querySelectorAll(".diamond")[i].classList.add("active");
        });
      });

      modal.querySelector("#cancelEdit").addEventListener("click", () => {
        modal.remove();
      });

      modal.querySelector("#saveEdit").addEventListener("click", async () => {
        const newText = modal.querySelector("#opinionText").value.trim();
        if (!chosen || !newText) {
          alert("UzupeÅ‚nij ocenÄ™ i treÅ›Ä‡ opinii.");
          return;
        }
        try {
          await updateDoc(doc(db, "opinie", id), {
            ocena: chosen,
            tresc: newText,
            updatedAt: serverTimestamp()
          });
          modal.remove();
          loadUserOpinions();
        } catch (err) {
          console.error("BÅ‚Ä…d aktualizacji opinii:", err);
          alert("Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ opinii.");
        }
      });
    }

    // ===== Init
    loadUserOrders();
    loadUserOpinions();
    loadStatsDate();

    // Fade-in inicjalizacja
    document.querySelectorAll('.fade').forEach(el => {
      el.classList.add('visible');
    });
  </script>

  <!-- COOKIE BANNER -->
  <div id="cookie-banner" class="cookie-banner" style="display:none;">
    <div class="cookie-content">
      <p>
        ğŸª Ta strona korzysta z plikÃ³w cookie, aby zapewniÄ‡ Ci najlepsze doÅ›wiadczenie,  
        analizowaÄ‡ ruch oraz wyÅ›wietlaÄ‡ dopasowane reklamy Google.  
        WiÄ™cej informacji znajdziesz w naszej  
        <a href="/pages/cookies.html" target="_blank">Polityce plikÃ³w cookies</a>.
      </p>
      <div class="cookie-actions">
        <button id="acceptCookies" class="cta">AkceptujÄ™</button>
        <button id="declineCookies" class="cta secondary">OdrzuÄ‡</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const banner = document.getElementById("cookie-banner");
    const accepted = localStorage.getItem("lumena_cookies_accepted");
    if (!accepted) banner.style.display = "flex";
    document.getElementById("acceptCookies").addEventListener("click", () => {
      localStorage.setItem("lumena_cookies_accepted", "true");
      banner.style.display = "none";
    });
    document.getElementById("declineCookies").addEventListener("click", () => {
      localStorage.setItem("lumena_cookies_accepted", "false");
      banner.style.display = "none";
    });
  });
  </script>

  <style>
    /* ZachowujÄ™ TwÃ³j styl + dodajÄ™ lekkie uzupeÅ‚nienia pod zakÅ‚adki i opinie */

    .orders {
      margin-top: 30px;
      display: grid;
      gap: 20px;
    }
    .order-card {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .order-card h3 {
      color: var(--gold);
      margin-bottom: 6px;
    }
    .order-card .meta {
      color: #ccc;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .order-card .desc {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    .order-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ZakÅ‚adki (spÃ³jne z panelem firmy/admina) */
    .admin-tabs-nav .tab-btn.active { background: var(--gold); color: var(--black); }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    .admin-card {
      background:#1a1a1a;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:24px;
      margin-bottom:24px;
    }
    .admin-card h2 { color:var(--gold); margin-bottom:12px; font-size:1.2rem; }

    .admin-grid { display:flex; flex-direction:column; gap:14px; }
    .admin-card-row {
      display:flex; gap:14px; justify-content:space-between; align-items:flex-start;
      background:#111; border:1px solid rgba(255,255,255,0.07); border-radius:12px; padding:16px;
    }
    .row-main { flex:1; }
    .row-head { display:flex; gap:12px; align-items:center; margin-bottom:6px; }
    .row-head .gold { color:var(--gold); }
    .row-head .diamonds { color:var(--gold); font-size:1.1rem; }
    .row-meta { display:flex; gap:14px; flex-wrap:wrap; margin-bottom:8px; }
    .row-meta .muted { color:#bbb; font-size:0.9rem; }
    .row-desc { color:#fff; line-height:1.5; }
    .row-actions { display:flex; flex-direction:column; gap:8px; }
    .cta.small { padding:6px 14px; border-radius:16px; font-size:0.85rem; }

    /* Modal edycji opinii */
    .opinion-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .opinion-modal-content {
      background: #171717; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding: 20px; width: 100%; max-width: 520px;
    }
    .opinion-modal-content h3 { color: var(--gold); margin-bottom: 10px; }
    .rating-row { font-size: 24px; margin-bottom: 10px; user-select: none; }
    .rating-row .diamond { cursor: pointer; margin-right: 6px; opacity: 0.6; }
    .rating-row .diamond.active { opacity: 1; }
    .opinion-modal-content textarea {
      width: 100%; background: #111; border: 1px solid rgba(255,255,255,0.12);
      color:#fff; border-radius: 10px; padding: 10px; margin-top: 8px;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }

    /* Animacje fade-in jak na stronie gÅ‚Ã³wnej */
    .fade { opacity: 0; transform: translateY(30px); transition: opacity .8s ease, transform .8s ease; }
    .fade.visible { opacity: 1; transform: translateY(0); }
  </style>
</body>
</html>
