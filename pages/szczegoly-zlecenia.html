<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SzczegÃ³Å‚y zlecenia â€” ZLECAJ z LUMENA</title>

  <meta name="description" content="Zobacz szczegÃ³Å‚y zlecenia, opis prac i oferty firm. Skontaktuj siÄ™ z wykonawcÄ… bez poÅ›rednikÃ³w â€” ZLECAJ z LUMENA.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="canonical" href="https://zlecajzlumena.pl/pages/szczegoly-zlecenia.html" />

  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="wrap flex between center-v">
      <a href="/" class="logo">
        <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA" height="48">
      </a>
      <nav class="nav">
        <a href="/pages/panel-klient.html">Panel klienta</a>
        <a href="#" id="logoutLink">Wyloguj siÄ™</a>
      </nav>
    </div>
  </header>

  <!-- SEKCJA SZCZEGÃ“ÅÃ“W -->
  <section class="zlecenie-details">
    <div class="wrap">
      <h1 id="zlec-title">Åadowanie...</h1>
      <p id="zlec-subtitle" class="subtitle"></p>

      <div class="details-card">
        <h2>Opis zlecenia</h2>
        <p id="zlec-opis"></p>
        <button id="deleteOrderBtn" class="cta secondary" style="display:none;">UsuÅ„ zlecenie</button>
      </div>

      <div class="offers-list">
        <h2 class="section-title">ZÅ‚oÅ¼one oferty firm</h2>
        <div id="offersContainer" class="offers"></div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="copy">
      Â© 2025 <span class="gold">LUMENA Creative</span> ğŸ’  
      <br><small>Wszystkie prawa zastrzeÅ¼one.</small>
    </div>
  </footer>

  <!-- ğŸ”¥ FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ğŸ”§ Konfiguracja Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDgaH3j1FKB0mPkCqH7VG9vwhX1q82NkR0",
      authDomain: "zlecaj-z-lumena.firebaseapp.com",
      projectId: "zlecaj-z-lumena",
      storageBucket: "zlecaj-z-lumena.appspot.com",
      messagingSenderId: "46650398157",
      appId: "1:46650398157:web:cd4d90782bb3039b8ce354",
      measurementId: "G-W8TCWBDE7Y"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const titleEl = document.getElementById("zlec-title");
    const subtitleEl = document.getElementById("zlec-subtitle");
    const opisEl = document.getElementById("zlec-opis");
    const deleteBtn = document.getElementById("deleteOrderBtn");
    const offersContainer = document.getElementById("offersContainer");

    let currentUser = null;

    // ğŸ”’ Wylogowanie
    document.getElementById("logoutLink").addEventListener("click", async (e) => {
      e.preventDefault();
      await signOut(auth);
      window.location.href = "/pages/login.html";
    });

    // ğŸ” Sprawdzenie logowania
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Musisz byÄ‡ zalogowany, aby zobaczyÄ‡ szczegÃ³Å‚y zlecenia ğŸ’");
        window.location.href = "/pages/login.html";
        return;
      }

      currentUser = user;
      await loadOrder();
      await loadOffers();
    });

    // ğŸ“¦ Pobieranie danych zlecenia
    async function loadOrder() {
      try {
        const docRef = doc(db, "zlecenia", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Nie znaleziono zlecenia.</h2>";
          return;
        }

        const data = docSnap.data();
        titleEl.textContent = data.tytul || "Bez tytuÅ‚u";
        subtitleEl.textContent = `${data.miasto || "Nieznane miasto"} â€¢ ${data.kategoria || "Brak kategorii"}`;
        opisEl.textContent = data.opis || "Brak opisu.";

        if (data.autorId === currentUser.uid) {
          deleteBtn.style.display = "inline-block";
          deleteBtn.addEventListener("click", async () => {
            if (confirm("Czy na pewno chcesz usunÄ…Ä‡ to zlecenie?")) {
              await deleteDoc(docRef);
              alert("Zlecenie zostaÅ‚o usuniÄ™te ğŸ—‘ï¸");
              window.location.href = "/pages/panel-klient.html";
            }
          });
        }
      } catch (err) {
        console.error("âŒ BÅ‚Ä…d pobierania zlecenia:", err);
        alert("Nie udaÅ‚o siÄ™ wczytaÄ‡ zlecenia.");
      }
    }

    // ğŸ“‹ Wczytanie ofert z danymi kontaktowymi firmy
    async function loadOffers() {
      offersContainer.innerHTML = "<p>Åadowanie ofert...</p>";
      try {
        const querySnapshot = await getDocs(collection(db, "zlecenia", id, "oferty"));
        if (querySnapshot.empty) {
          offersContainer.innerHTML = "<p>Brak ofert dla tego zlecenia ğŸ’¡</p>";
          return;
        }

        offersContainer.innerHTML = "";
        for (const docSnap of querySnapshot.docs) {
          const o = docSnap.data();
          const created = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString("pl-PL") : "â€”";

          // ğŸ“ Pobierz dane firmy z kolekcji "users"
          let kontaktHTML = "<em>Brak danych kontaktowych</em>";
          try {
            const userRef = doc(db, "users", o.autorId);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
              const u = userSnap.data();
              kontaktHTML = `
                <p><strong>ğŸ“ Telefon:</strong> ${u.telefon || "nie podano"}</p>
                <p><strong>âœ‰ï¸ E-mail:</strong> <a href="mailto:${u.email}">${u.email}</a></p>
              `;
            }
          } catch (err) {
            console.warn("Nie udaÅ‚o siÄ™ pobraÄ‡ danych kontaktowych:", err);
          }

          const div = document.createElement("div");
          div.classList.add("offer-card");
          div.innerHTML = `
            <h3>ğŸ¢ ${o.firma}</h3>
            <p><strong>ğŸ’° Kwota:</strong> ${o.kwota} PLN</p>
            <p><strong>ğŸ“ Opis:</strong> ${o.opis}</p>
            ${kontaktHTML}
            <small>ğŸ“… Dodano: ${created}</small>
          `;
          offersContainer.appendChild(div);
        }
      } catch (err) {
        console.error("âŒ BÅ‚Ä…d pobierania ofert:", err);
        offersContainer.innerHTML = "<p>Nie udaÅ‚o siÄ™ pobraÄ‡ ofert.</p>";
      }
    }
  </script>

  <!-- ğŸª BANER COOKIES -->
  <div id="cookie-banner" class="cookie-banner" style="display:none;">
    <div class="cookie-content">
      <p>
        ğŸª Ta strona korzysta z plikÃ³w cookie, aby zapewniÄ‡ Ci najlepsze doÅ›wiadczenie,  
        analizowaÄ‡ ruch oraz wyÅ›wietlaÄ‡ dopasowane reklamy Google.  
        WiÄ™cej informacji znajdziesz w naszej  
        <a href="/pages/cookies.html" target="_blank">Polityce plikÃ³w cookies</a>.
      </p>
      <div class="cookie-actions">
        <button id="acceptCookies" class="cta">AkceptujÄ™</button>
        <button id="declineCookies" class="cta secondary">OdrzuÄ‡</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const banner = document.getElementById("cookie-banner");
    const accepted = localStorage.getItem("lumena_cookies_accepted");
    if (!accepted) banner.style.display = "flex";
    document.getElementById("acceptCookies").addEventListener("click", () => {
      localStorage.setItem("lumena_cookies_accepted", "true");
      banner.style.display = "none";
    });
    document.getElementById("declineCookies").addEventListener("click", () => {
      localStorage.setItem("lumena_cookies_accepted", "false");
      banner.style.display = "none";
    });
  });
  </script>

  <style>
    .details-card, .offer-card {
      background: #111;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .offers {
      display: grid;
      gap: 20px;
    }
    .offer-card h3 {
      color: var(--gold);
      margin-bottom: 6px;
    }
    .offer-card a {
      color: var(--gold);
      text-decoration: underline;
    }
  </style>
</body>
</html>
