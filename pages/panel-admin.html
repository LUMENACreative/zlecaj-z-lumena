<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administratora ‚Äî ZLECAJ z LUMENA</title>

  <meta name="description" content="Panel administratora ZLECAJ z LUMENA ‚Äî zarzƒÖdzanie opiniami, u≈ºytkownikami i zleceniami.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <header class="topbar panel-header">
    <div class="wrap flex between center-v">
      <div class="logo-area flex center-v">
        <a href="/" class="logo">
          <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA logo" height="64" />
        </a>
        <span class="panel-title">Panel Administratora</span>
      </div>
      <nav class="panel-nav flex center-v">
        <button id="logoutBtn" class="cta secondary">Wyloguj siƒô</button>
      </nav>
    </div>
  </header>

  <section class="panel">
    <div class="wrap">
      <h1 class="center" style="color:var(--gold)">Witaj, Administratorze üíé</h1>
      <p class="subtitle">ZarzƒÖdzaj opiniami, u≈ºytkownikami i zleceniami.</p>

      <div class="admin-tabs-nav center" style="margin-bottom:24px;">
        <button class="tab-btn cta secondary active" data-tab="opinieTab">Opinie üíé</button>
        <button class="tab-btn cta secondary" data-tab="uzytkownicyTab">U≈ºytkownicy üë•</button>
        <button class="tab-btn cta secondary" data-tab="zleceniaTab">Zlecenia üß±</button>
      </div>

      <div class="admin-tabs">
        <div id="opinieTab" class="tab-pane active">
          <div class="admin-card">
            <h2>Opinie (od najnowszych)</h2>
            <div id="opinieListAdmin" class="admin-list">
              <p>≈Åadowanie opinii...</p>
            </div>
          </div>
        </div>

        <div id="uzytkownicyTab" class="tab-pane">
          <div class="admin-card">
            <h2>Firmy</h2>
            <div id="firmyListAdmin" class="admin-list">
              <p>≈Åadowanie firm...</p>
            </div>
          </div>

          <div class="admin-card" style="margin-top:24px;">
            <h2>Klienci</h2>
            <div id="klienciListAdmin" class="admin-list">
              <p>≈Åadowanie klient√≥w...</p>
            </div>
          </div>
        </div>

        <div id="zleceniaTab" class="tab-pane">
          <div class="admin-card">
            <h2>Zlecenia (od najnowszych)</h2>
            <div id="zleceniaListAdmin" class="admin-list">
              <p>≈Åadowanie zlece≈Ñ...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="lumena-footer">
    <div class="copy">
      ¬© 2025 <span class="gold">LUMENA Creative</span> üíé  
      <br><small>Wszystkie prawa zastrze≈ºone.</small>
    </div>
  </footer>

  <script type="module">
    import { app, db } from "/js/firebase.js";
    import {
      collection, getDocs, getDoc, doc,
      query, orderBy, deleteDoc, where
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const loggedIn = localStorage.getItem("loggedIn");
    const userEmail = localStorage.getItem("userEmail");
    const userType  = localStorage.getItem("userType");
    const ADMIN_EMAIL = "arkadiuszgruca41@gmail.com";

    if (!loggedIn || userEmail !== ADMIN_EMAIL) {
      alert("Dostƒôp tylko dla administratora.");
      window.location.href = "/pages/login.html";
    } else if (userType !== "admin") {
      localStorage.setItem("userType", "admin");
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      if (confirm("Czy chcesz siƒô wylogowaƒá?")) {
        localStorage.clear();
        window.location.href = "/pages/login.html";
      }
    });

    const opinieListAdmin   = document.getElementById("opinieListAdmin");
    const firmyListAdmin    = document.getElementById("firmyListAdmin");
    const klienciListAdmin  = document.getElementById("klienciListAdmin");
    const zleceniaListAdmin = document.getElementById("zleceniaListAdmin");

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    const firmNameCache = new Map();
    async function getFirmName(firmId) {
      if (!firmId) return "(brak ID firmy)";
      if (firmNameCache.has(firmId)) return firmNameCache.get(firmId);
      try {
        const snap = await getDoc(doc(db, "firmy", firmId));
        const name = snap.exists() ? (snap.data().nazwa || "(bez nazwy)") : "(nie znaleziono)";
        firmNameCache.set(firmId, name);
        return name;
      } catch {
        return "(b≈ÇƒÖd pobierania)";
      }
    }

    async function loadOpinieAdmin() {
      opinieListAdmin.innerHTML = "<p>≈Åadowanie opinii...</p>";
      try {
        const qOpinie = query(collection(db, "opinie"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qOpinie);
        if (snap.empty) {
          opinieListAdmin.innerHTML = "<p>Brak opinii. Kolekcja utworzy siƒô automatycznie przy pierwszej opinii.</p>";
          return;
        }

        const list = document.createElement("div");
        list.classList.add("admin-grid");
        for (const docSnap of snap.docs) {
          const o = docSnap.data();
          const firmName = await getFirmName(o.firmId);
          let diamonds = "";
          for (let i = 1; i <= 5; i++) diamonds += i <= (o.ocena || 0) ? "üíé" : "‚óá";
          const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString("pl-PL") : "";

          const card = document.createElement("div");
          card.classList.add("admin-card-row");
          card.innerHTML = `
            <div class="row-main">
              <div class="row-head"><strong class="gold">${firmName}</strong><span class="diamonds">${diamonds}</span></div>
              <div class="row-meta"><span class="muted">Autor: ${o.autorEmail || "Anonim"}</span><span class="muted">Data: ${dateStr}</span></div>
              <p class="row-desc">${o.tresc || ""}</p>
            </div>
            <div class="row-actions"><button class="cta small secondary delete-opinia" data-id="${docSnap.id}">Usu≈Ñ</button></div>
          `;
          list.appendChild(card);
        }
        opinieListAdmin.innerHTML = "";
        opinieListAdmin.appendChild(list);
      } catch (err) {
        console.error("B≈ÇƒÖd ≈Çadowania opinii:", err);
        opinieListAdmin.innerHTML = `<p>‚ùå Nie uda≈Ço siƒô pobraƒá opinii (${err.code || "brak kodu"}).</p>`;
      }
    }

    opinieListAdmin.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-opinia")) {
        const id = e.target.dataset.id;
        if (!id) return;
        if (confirm("UsunƒÖƒá tƒô opiniƒô?")) {
          try {
            await deleteDoc(doc(db, "opinie", id));
            loadOpinieAdmin();
          } catch (err) {
            console.error("B≈ÇƒÖd usuwania opinii:", err);
            alert("‚ùå Nie uda≈Ço siƒô usunƒÖƒá opinii: " + (err.code || err.message));
          }
        }
      }
    });

    async function loadUzytkownicyAdmin() {
      firmyListAdmin.innerHTML = "<p>≈Åadowanie firm...</p>";
      try {
        const snapFirmy = await getDocs(collection(db, "firmy"));
        if (snapFirmy.empty) {
          firmyListAdmin.innerHTML = "<p>Brak firm.</p>";
        } else {
          const items = snapFirmy.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a, b) => (a.nazwa || "").localeCompare(b.nazwa || ""));
          const list = document.createElement("div");
          list.classList.add("admin-grid");
          items.forEach(f => {
            list.innerHTML += `
              <div class="admin-card-row">
                <div class="row-main">
                  <div class="row-head"><strong class="gold">${f.nazwa || "(bez nazwy)"}</strong><span class="muted">${f.branza || ""}</span></div>
                  <div class="row-meta"><span class="muted">E-mail: ${f.email || "-"}</span><span class="muted">Miasto: ${f.miasto || "-"}</span></div>
                  <p class="row-desc">${f.opis || ""}</p>
                </div>
              </div>`;
          });
          firmyListAdmin.innerHTML = "";
          firmyListAdmin.appendChild(list);
        }
      } catch (err) {
        console.error("B≈ÇƒÖd ≈Çadowania firm:", err);
        firmyListAdmin.innerHTML = `<p>‚ùå B≈ÇƒÖd: ${err.code || "brak szczeg√≥≈Ç√≥w"}</p>`;
      }

      try {
        const snapKlienci = await getDocs(query(collection(db, "uzytkownicy"), where("typ", "==", "client")));
        if (snapKlienci.empty) {
          klienciListAdmin.innerHTML = "<p>Brak klient√≥w.</p>";
        } else {
          const list = document.createElement("div");
          list.classList.add("admin-grid");
          snapKlienci.docs.forEach(u => {
            const d = u.data();
            list.innerHTML += `
              <div class="admin-card-row">
                <div class="row-main">
                  <div class="row-head"><strong class="gold">${d.email || "(bez e-maila)"}</strong><span class="muted">client</span></div>
                  <div class="row-meta"><span class="muted">Imiƒô: ${d.imie || "-"}</span><span class="muted">Miasto: ${d.miasto || "-"}</span></div>
                </div>
              </div>`;
          });
          klienciListAdmin.innerHTML = "";
          klienciListAdmin.appendChild(list);
        }
      } catch (err) {
        console.warn("B≈ÇƒÖd ≈Çadowania klient√≥w:", err);
        klienciListAdmin.innerHTML = "<p>Nie uda≈Ço siƒô pobraƒá danych o klientach.</p>";
      }
    }

    async function loadZleceniaAdmin() {
      zleceniaListAdmin.innerHTML = "<p>≈Åadowanie zlece≈Ñ...</p>";
      try {
        const qZlec = query(collection(db, "zlecenia"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qZlec);
        if (snap.empty) {
          zleceniaListAdmin.innerHTML = "<p>Brak zlece≈Ñ. Kolekcja utworzy siƒô automatycznie.</p>";
          return;
        }
        const list = document.createElement("div");
        list.classList.add("admin-grid");
        snap.forEach(docSnap => {
          const z = docSnap.data();
          const dateStr = z.createdAt?.toDate ? z.createdAt.toDate().toLocaleDateString("pl-PL") : "";
          list.innerHTML += `
            <div class="admin-card-row">
              <div class="row-main">
                <div class="row-head"><strong class="gold">${z.tytul || "(bez tytu≈Çu)"}</strong><span class="muted">${z.miasto || "-"}</span></div>
                <div class="row-meta"><span class="muted">Autor: ${z.autorEmail || "-"}</span><span class="muted">Data: ${dateStr}</span></div>
                <p class="row-desc">${z.opis || ""}</p>
              </div>
              <div class="row-actions"><button class="cta small secondary delete-zlecenie" data-id="${docSnap.id}">Usu≈Ñ</button></div>
            </div>`;
        });
        zleceniaListAdmin.innerHTML = "";
        zleceniaListAdmin.appendChild(list);
      } catch (err) {
        console.error("B≈ÇƒÖd ≈Çadowania zlece≈Ñ:", err);
        zleceniaListAdmin.innerHTML = `<p>‚ùå Nie uda≈Ço siƒô pobraƒá zlece≈Ñ (${err.code || "brak kodu"}).</p>`;
      }
    }

    zleceniaListAdmin.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-zlecenie")) {
        const id = e.target.dataset.id;
        if (!id) return;
        if (confirm("UsunƒÖƒá to zlecenie?")) {
          try {
            await deleteDoc(doc(db, "zlecenia", id));
            loadZleceniaAdmin();
          } catch (err) {
            console.error("B≈ÇƒÖd usuwania zlecenia:", err);
            alert("Nie uda≈Ço siƒô usunƒÖƒá zlecenia.");
          }
        }
      }
    });

    loadOpinieAdmin();
    loadUzytkownicyAdmin();
    loadZleceniaAdmin();
  </script>

  <style>
    .admin-tabs-nav .tab-btn.active { background: var(--gold); color: var(--black); }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .admin-card {
      background:#1a1a1a; border:1px solid rgba(255,255,255,0.08);
      border-radius:14px; padding:24px; margin-bottom:24px;
    }
    .admin-card h2 { color:var(--gold); margin-bottom:16px; font-size:1.2rem; }
    .admin-grid { display:flex; flex-direction:column; gap:14px; }
    .admin-card-row {
      display:flex; gap:14px; justify-content:space-between; align-items:flex-start;
      background:#111; border:1px solid rgba(255,255,255,0.07); border-radius:12px; padding:16px;
    }
    .row-main { flex:1; }
    .row-head { display:flex; gap:12px; align-items:center; margin-bottom:6px; }
    .row-head .gold { color:var(--gold); }
    .row-head .diamonds { color:var(--gold); font-size:1.1rem; }
    .row-meta { display:flex; gap:14px; flex-wrap:wrap; margin-bottom:8px; }
    .row-meta .muted { color:#bbb; font-size:0.9rem; }
    .row-desc { color:#fff; line-height:1.5; }
    .row-actions { display:flex; flex-direction:column; gap:8px; }
    .cta.small { padding:6px 14px; border-radius:16px; font-size:0.85rem; }
  </style>
</body>
</html>
