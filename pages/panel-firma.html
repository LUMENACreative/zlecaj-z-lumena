<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Wykonawcy â€” ZLECAJ z LUMENA</title>

  <meta name="description" content="Panel wykonawcy â€” zarzÄ…dzaj swoim profilem, opiniami i statystykami.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="topbar panel-header">
    <div class="wrap flex between center-v">
      <div class="logo-area flex center-v">
        <a href="/" class="logo">
          <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA logo" height="64" />
        </a>
        <span class="panel-title">Panel Wykonawcy</span>
      </div>

      <nav class="panel-nav flex center-v">
        <button id="logoutBtn" class="cta secondary">Wyloguj siÄ™</button>
      </nav>
    </div>
  </header>

  <!-- PANEL -->
  <main class="panel">
    <div class="wrap">
      <h1 class="center" style="color:var(--gold)">Witaj w panelu wykonawcy ğŸ’</h1>
      <p class="subtitle center">ZarzÄ…dzaj profilem, opiniami i statystykami.</p>

      <!-- Nawigacja -->
      <div class="admin-tabs-nav center" style="margin-bottom:24px;">
        <button class="tab-btn cta secondary active" data-tab="profilTab">ğŸ’¼ Profil firmy</button>
        <button class="tab-btn cta secondary" data-tab="opinieTab">ğŸ’ Opinie klientÃ³w</button>
        <button class="tab-btn cta secondary" data-tab="statystykiTab">ğŸ“Š Statystyki</button>
      </div>

      <!-- ZawartoÅ›Ä‡ -->
      <div class="admin-tabs">

        <!-- PROFIL -->
        <div id="profilTab" class="tab-pane active">
          <div class="admin-card">
            <h2>Edytuj dane firmy</h2>
            <form id="editFirmForm" class="zlecenie-form">
              <div class="form-group grid-2">
                <div>
                  <label for="nazwa">Nazwa firmy</label>
                  <input type="text" id="nazwa" required />
                </div>
                <div>
                  <label for="email">E-mail</label>
                  <input type="email" id="email" disabled />
                </div>
              </div>

              <div class="form-group grid-2">
                <div>
                  <label for="telefon">Telefon</label>
                  <input type="text" id="telefon" />
                </div>
                <div>
                  <label for="miasto">Miasto</label>
                  <input type="text" id="miasto" />
                </div>
              </div>

              <div class="form-group">
                <label for="branza">BranÅ¼a</label>
                <input type="text" id="branza" />
              </div>

              <div class="form-group">
                <label for="opis">Opis</label>
                <textarea id="opis" rows="4"></textarea>
              </div>

              <button type="submit" class="cta">ğŸ’¾ Zapisz zmiany</button>
            </form>
          </div>
        </div>

        <!-- OPINIE -->
        <div id="opinieTab" class="tab-pane">
          <div class="admin-card">
            <h2>Opinie klientÃ³w</h2>
            <p id="avgRating" style="margin-bottom:15px;color:var(--gold);"></p>
            <div id="opinieList" class="admin-list">
              <p>Åadowanie opinii...</p>
            </div>
          </div>
        </div>

        <!-- STATYSTYKI -->
        <div id="statystykiTab" class="tab-pane">
          <div class="admin-card">
            <h2>Twoje statystyki</h2>
            <div class="grid-3">
              <div class="card-stats">
                <div class="icon">ğŸ’</div>
                <h3 id="statOpinie">0</h3>
                <p>ÅÄ…czna liczba opinii</p>
              </div>
              <div class="card-stats">
                <div class="icon">â­</div>
                <h3 id="statSrednia">0.0</h3>
                <p>Åšrednia ocena</p>
              </div>
              <div class="card-stats">
                <div class="icon">ğŸ“…</div>
                <h3 id="statData">-</h3>
                <p>Data rejestracji</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="copy">
      Â© 2025 <span class="gold">LUMENA Creative</span> ğŸ’  
      <br><small>Wszystkie prawa zastrzeÅ¼one.</small>
    </div>
  </footer>

  <!-- ğŸ”¥ LOGIKA -->
  <script type="module">
    import { db } from "/js/firebase.js";
    import {
      collection, getDocs, doc, getDoc, updateDoc, query, where, orderBy, setDoc, addDoc, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const loggedIn = localStorage.getItem("loggedIn");
    const userType = localStorage.getItem("userType");
    const userEmail = localStorage.getItem("userEmail");

    if (!loggedIn || userType !== "company") {
      alert("DostÄ™p tylko dla zalogowanych wykonawcÃ³w ğŸ’¼");
      window.location.href = "/pages/login.html";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      if (confirm("Czy chcesz siÄ™ wylogowaÄ‡?")) {
        localStorage.clear();
        window.location.href = "/pages/login.html";
      }
    });

    // ====== Taby ======
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanes = document.querySelectorAll(".tab-pane");
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        tabPanes.forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    // ====== Profil ======
    const form = document.getElementById("editFirmForm");
    async function loadFirmData() {
      const q = query(collection(db, "firmy"), where("email", "==", userEmail));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const docRef = snap.docs[0];
        const data = docRef.data();
        form.dataset.id = docRef.id;
        document.getElementById("nazwa").value = data.nazwa || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("telefon").value = data.telefon || "";
        document.getElementById("miasto").value = data.miasto || "";
        document.getElementById("branza").value = data.branza || "";
        document.getElementById("opis").value = data.opis || "";
        document.getElementById("statData").textContent = data.dataRejestracji
          ? new Date(data.dataRejestracji).toLocaleDateString("pl-PL")
          : "-";
      }
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const id = form.dataset.id;
      if (!id) return alert("BÅ‚Ä…d: nie znaleziono ID firmy.");
      const ref = doc(db, "firmy", id);
      await updateDoc(ref, {
        nazwa: document.getElementById("nazwa").value,
        telefon: document.getElementById("telefon").value,
        miasto: document.getElementById("miasto").value,
        branza: document.getElementById("branza").value,
        opis: document.getElementById("opis").value,
      });
      alert("âœ… Dane firmy zostaÅ‚y zaktualizowane!");
    });

    // ====== Opinie ======
    async function loadOpinie() {
      const list = document.getElementById("opinieList");
      const avg = document.getElementById("avgRating");

      // SprawdÅº, czy kolekcja istnieje (utworzy siÄ™ automatycznie)
      const q = query(collection(db, "opinie"), where("firmEmail", "==", userEmail), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = "<p>Brak opinii dla Twojej firmy ğŸ’</p>";
        avg.textContent = "";
        document.getElementById("statOpinie").textContent = "0";
        document.getElementById("statSrednia").textContent = "0.0";
        return;
      }

      let total = 0;
      const container = document.createElement("div");
      container.classList.add("admin-grid");

      snap.forEach(docSnap => {
        const o = docSnap.data();
        total += o.ocena || 0;
        const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString("pl-PL") : "";
        let diamonds = "";
        for (let i = 1; i <= 5; i++) diamonds += i <= o.ocena ? "ğŸ’" : "â—‡";

        const div = document.createElement("div");
        div.classList.add("admin-card-row");
        div.innerHTML = `
          <div class="row-main">
            <div class="row-head"><strong class="gold">${o.autorEmail || "Anonim"}</strong> <span class="diamonds">${diamonds}</span></div>
            <div class="row-meta"><span class="muted">${dateStr}</span></div>
            <p class="row-desc">${o.tresc || ""}</p>
          </div>
        `;
        container.appendChild(div);
      });

      const avgScore = (total / snap.size).toFixed(1);
      avg.textContent = `Åšrednia ocen: ${avgScore} / 5 ğŸ’`;
      document.getElementById("statOpinie").textContent = snap.size;
      document.getElementById("statSrednia").textContent = avgScore;

      list.innerHTML = "";
      list.appendChild(container);
    }

    loadFirmData();
    loadOpinie();
  </script>

  <style>
    .tab-btn.active { background: var(--gold); color: var(--black); }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
  </style>
</body>
</html>
