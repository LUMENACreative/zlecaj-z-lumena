<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil firmy ‚Äî ZLECAJ z LUMENA</title>

  <meta name="description" content="Profil wykonawcy ‚Äî edytuj dane firmy, dodawaj zdjƒôcia i filmy realizacji oraz przeglƒÖdaj opinie klient√≥w.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="canonical" href="https://zlecajzlumena.pl/pages/profil-firmy.html" />
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="topbar panel-header">
    <div class="wrap flex between center-v">
      <div class="logo-area flex center-v">
        <a href="/" class="logo"><img src="/image/zlecaj-z-lumena.png" height="64" alt="ZLECAJ z LUMENA" /></a>
        <span class="panel-title">Profil firmy</span>
      </div>
      <nav class="panel-nav flex center-v">
        <a href="/pages/panel-firma.html" class="cta">Panel Wykonawcy</a>
        <button id="logoutBtn" class="cta secondary">Wyloguj siƒô</button>
      </nav>
    </div>
  </header>

  <!-- PROFIL -->
  <section class="firm-profile">
    <div class="wrap">
      <h1 id="firmName">Twoja firma</h1>
      <p id="firmBranch" class="branch">Bran≈ºa</p>
      <p id="firmLocation" class="location">Lokalizacja</p>
      <p id="firmAbout">Tutaj pojawi siƒô opis Twojej dzia≈Çalno≈õci.</p>

      <ul id="firmSkills" class="skills-list"></ul>

      <div class="profile-actions center">
        <button id="editProfileBtn" class="cta">Edytuj profil</button>
        <button id="addProjectBtn" class="cta secondary">Dodaj realizacjƒô</button>
        <p id="profileLink" class="gold small" style="margin-top:10px;"></p>
      </div>

      <div id="projectsSection" style="margin-top:40px;">
        <h2>Twoje realizacje</h2>
        <div id="projectsGrid" class="projects-grid"></div>
      </div>

      <!-- üîπ Sekcja opinii klient√≥w -->
      <div id="opinieSection" style="margin-top:60px;">
        <h2>Opinie klient√≥w üíé</h2>
        <p id="avgRating" class="gold" style="margin-bottom:20px;"></p>
        <div id="opinieList" class="opinie-list"><p>≈Åadowanie opinii...</p></div>

        <div id="addOpinionBox" class="add-opinion" style="margin-top:30px;">
          <h3>Dodaj swojƒÖ opiniƒô</h3>
          <form id="opiniaForm">
            <label>Twoja ocena:</label>
            <div id="ratingStars" class="rating-stars"></div>
            <textarea id="opiniaText" rows="3" placeholder="Napisz swojƒÖ opiniƒô..." required></textarea>
            <button type="submit" class="cta">Dodaj opiniƒô</button>
          </form>
          <p id="opiniaMsg" class="gold small" style="display:none; margin-top:10px;">Twoja opinia zosta≈Ça dodana üíé</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MODAL: EDKYCJA PROFILU -->
  <div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Edytuj profil firmy</h2>
      <form id="editForm">
        <label>Nazwa firmy</label><input id="editName" required>
        <label>Bran≈ºa</label><input id="editBranch">
        <label>Lokalizacja</label><input id="editLocation">
        <label>Opis firmy</label><textarea id="editAbout" rows="4"></textarea>
        <label>Specjalizacje (oddziel przecinkami)</label><input id="editSkills">
        <label>E-mail kontaktowy</label><input type="email" id="editEmail">
        <div class="modal-actions">
          <button type="submit" class="cta">Zapisz</button>
          <button type="button" id="cancelEdit" class="cta secondary">Anuluj</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: DODAWANIE REALIZACJI -->
  <div id="projectModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Dodaj realizacjƒô</h2>
      <form id="projectForm">
        <label>Opis realizacji</label>
        <textarea id="projectOpis" rows="3" placeholder="np. Remont kuchni w Krakowie"></textarea>

        <label>Typ realizacji</label>
        <select id="projectType">
          <option value="zdjecie">Zdjƒôcie</option>
          <option value="film">Film (YouTube)</option>
        </select>

        <div id="uploadSection">
          <label>Wybierz plik (zdjƒôcie)</label>
          <input type="file" id="projectFile" accept="image/*">
        </div>

        <div id="linkSection" style="display:none;">
          <label>Link do filmu (YouTube)</label>
          <input type="url" id="projectLink" placeholder="https://youtube.com/watch?v=...">
        </div>

        <div class="modal-actions">
          <button type="submit" class="cta">Dodaj</button>
          <button type="button" id="cancelProject" class="cta secondary">Anuluj</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="copy">¬© 2025 <span class="gold">LUMENA Creative</span> üíé</div>
  </footer>

  <!-- üî• FIREBASE SKRYPT -->
  <script type="module">
    import { db } from "/js/firebase.js";
    import { collection, getDocs, query, where, updateDoc, doc, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    const userEmail = localStorage.getItem("lumena_user_email");
    const userType = localStorage.getItem("userType");
    const storage = getStorage();
    const opinieList = document.getElementById("opinieList");
    const opiniaForm = document.getElementById("opiniaForm");
    const opiniaMsg = document.getElementById("opiniaMsg");
    const avgRating = document.getElementById("avgRating");

    const editBtn = document.getElementById("editProfileBtn");
    const modal = document.getElementById("editModal");
    const cancelEdit = document.getElementById("cancelEdit");
    const projectBtn = document.getElementById("addProjectBtn");
    const projectModal = document.getElementById("projectModal");
    const cancelProject = document.getElementById("cancelProject");
    const projectsGrid = document.getElementById("projectsGrid");

    let firmId = null;
    let realizacje = [];
    let currentRating = 0;

    // üîπ Wczytaj dane firmy
    async function loadFirm() {
      if (!userEmail) return;
      const q = query(collection(db, "firmy"), where("email", "==", userEmail));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return;

      const firmDoc = snapshot.docs[0];
      firmId = firmDoc.id;
      const data = firmDoc.data();

      document.getElementById("firmName").textContent = data.nazwa || "";
      document.getElementById("firmBranch").textContent = data.branza || "";
      document.getElementById("firmLocation").textContent = data.lokalizacja || "";
      document.getElementById("firmAbout").textContent = data.opis || "";

      const skillsList = document.getElementById("firmSkills");
      skillsList.innerHTML = "";
      (data.specjalizacje || []).forEach(s => {
        const li = document.createElement("li");
        li.textContent = s;
        skillsList.appendChild(li);
      });

      realizacje = data.realizacje || [];
      renderProjects();
      loadOpinie();
    }

    // üî∏ Renderuj realizacje
    function renderProjects() {
      projectsGrid.innerHTML = "";
      if (realizacje.length === 0) {
        projectsGrid.innerHTML = "<p>Brak dodanych realizacji.</p>";
        return;
      }
      realizacje.forEach((r, i) => {
        const div = document.createElement("div");
        div.classList.add("project-card");
        div.innerHTML = r.typ === "zdjecie"
          ? `<img src="${r.url}" alt=""><p>${r.opis || ""}</p><button class="delete-btn" data-index="${i}">üóëÔ∏è Usu≈Ñ</button>`
          : `<iframe src="${r.url.replace("watch?v=", "embed/")}" allowfullscreen></iframe><p>${r.opis || ""}</p><button class="delete-btn" data-index="${i}">üóëÔ∏è Usu≈Ñ</button>`;
        projectsGrid.appendChild(div);
      });
    }

    // üî∏ Opinie
    async function loadOpinie() {
      if (!firmId) return;
      const q = query(collection(db, "opinie"), where("firmaId", "==", firmId), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      opinieList.innerHTML = "";

      if (snapshot.empty) {
        opinieList.innerHTML = "<p>Brak opinii.</p>";
        avgRating.textContent = "";
        return;
      }

      let sum = 0;
      let count = 0;
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        sum += d.ocena;
        count++;
        const div = document.createElement("div");
        div.classList.add("opinia");
        const diamenty = "üíé".repeat(d.ocena);
        div.innerHTML = `
          <p class="rating">${diamenty}</p>
          <p class="text">${d.tresc}</p>
          <p class="meta">${d.autor || "Anonim"} ‚Äî ${d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString("pl-PL") : ""}</p>
        `;
        opinieList.appendChild(div);
      });
      const avg = (sum / count).toFixed(1);
      avgRating.textContent = `≈örednia ocen: ${avg} üíé`;
    }

    // üîπ Dodawanie opinii
    if (opiniaForm) {
      const starsDiv = document.getElementById("ratingStars");
      for (let i = 1; i <= 5; i++) {
        const span = document.createElement("span");
        span.textContent = "üíé";
        span.classList.add("star");
        span.dataset.value = i;
        span.addEventListener("click", () => {
          currentRating = i;
          document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));
          for (let j = 0; j < i; j++) document.querySelectorAll(".star")[j].classList.add("active");
        });
        starsDiv.appendChild(span);
      }

      opiniaForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (currentRating === 0) return alert("Wybierz ocenƒô üíé");
        const tresc = opiniaText.value.trim();
        if (!tresc) return;

        await addDoc(collection(db, "opinie"), {
          firmaId,
          autor: userEmail,
          tresc,
          ocena: currentRating,
          createdAt: serverTimestamp()
        });

        opiniaForm.reset();
        currentRating = 0;
        document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));
        opiniaMsg.style.display = "block";
        setTimeout(() => (opiniaMsg.style.display = "none"), 2500);
        loadOpinie();
      });
    }

    // üö™ Wylogowanie
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/pages/login.html";
    });

    loadFirm();
  </script>

  <style>
    .projects-grid { margin-top:20px; display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); }
    .project-card { background:#111; border-radius:10px; padding:10px; text-align:center; position:relative; }
    .project-card img { width:100%; border-radius:8px; }
    .project-card iframe { width:100%; height:180px; border-radius:8px; }
    .delete-btn { margin-top:8px; background:transparent; border:1px solid #ff4d4d; color:#ff4d4d; padding:6px 12px; border-radius:8px; cursor:pointer; }
    .delete-btn:hover { background:#ff4d4d; color:#000; }

    .opinie-list { margin-top:20px; display:grid; gap:15px; }
    .opinia { background:#111; border-radius:10px; padding:15px; border:1px solid rgba(255,255,255,0.1); }
    .opinia .rating { color:var(--gold); font-size:20px; }
    .opinia .meta { color:#aaa; font-size:13px; margin-top:5px; }
    .rating-stars { font-size:28px; cursor:pointer; user-select:none; }
    .rating-stars .star { opacity:0.5; transition:0.2s; }
    .rating-stars .star.active, .rating-stars .star:hover { opacity:1; transform:scale(1.2); }
    .add-opinion textarea { width:100%; margin-top:10px; background:#111; color:#fff; border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:10px; }
  </style>
</body>
</html>
