<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil wykonawcy â€” ZLECAJ z LUMENA</title>

  <meta name="description" content="Zobacz profil wykonawcy â€” opis dziaÅ‚alnoÅ›ci, specjalizacje i realizacje. Wybierz najlepszego fachowca na ZLECAJ z LUMENA.">
  <meta name="author" content="LUMENA Creative" />
  <link rel="icon" href="/image/favicon.png" type="image/png">
  <meta name="theme-color" content="#0b0b0f" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="wrap flex between center-v">
      <a href="/" class="logo">
        <img src="/image/zlecaj-z-lumena.png" alt="ZLECAJ z LUMENA logo" height="48" />
      </a>
      <nav class="nav">
        <a href="/pages/zlecenia.html">Zlecenia</a>
        <a href="/pages/login.html" class="cta small">Zaloguj siÄ™</a>
      </nav>
    </div>
  </header>

  <!-- PROFIL FIRMY -->
  <section class="firm-profile">
    <div class="wrap">
      <div class="profile-header">
        <div class="avatar" id="firmAvatar">ğŸ—ï¸</div>
        <div class="info">
          <h1 id="firmName">Åadowanie...</h1>
          <span id="avgRating" class="avg-rating" style="margin-left:8px;"></span>
          <p id="firmBranch" class="branch"></p>
          <p id="firmLocation" class="location"></p>
        </div>
      </div>

      <div class="profile-about">
        <h2>O firmie</h2>
        <p id="firmAbout">Wczytywanie danych firmy...</p>
      </div>

      <div class="profile-skills" style="display:none;">
        <h2>Specjalizacje</h2>
        <ul id="firmSkills" class="skills-list"></ul>
      </div>

      <!-- REALIZACJE -->
      <div id="firmProjects" class="profile-projects" style="display:none;">
        <h2>Realizacje firmy</h2>
        <div id="projectsGrid" class="projects-grid"></div>
      </div>

      <!-- OPINIE -->
      <div id="opinieSection" class="opinie-section">
        <h2>Opinie klientÃ³w ğŸ’</h2>
        <div id="opinieAuthInfo" style="display:none;">Zaloguj siÄ™ jako klient, aby dodaÄ‡ opiniÄ™ ğŸ’</div>

        <div id="addOpinionBox" style="display:none;">
          <h3>Dodaj swojÄ… opiniÄ™</h3>
          <div id="ratingStars" class="rating-diamonds"></div>
          <textarea id="opiniaText" placeholder="Napisz swojÄ… opiniÄ™..." maxlength="500"></textarea>
          <div class="opinie-actions"><button id="submitOpinion" class="cta">Dodaj opiniÄ™</button></div>
        </div>

        <div id="opinieList" class="opinie-list"><p>Åadowanie opinii...</p></div>
      </div>

      <div class="cta-container center" style="margin-top:30px;">
        <a id="contactBtn" href="#" class="cta">Skontaktuj siÄ™ z firmÄ…</a>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="lumena-footer">
    <div class="copy">Â© 2025 <span class="gold">LUMENA Creative</span> ğŸ’</div>
  </footer>

  <!-- FIREBASE LOGIKA -->
  <script type="module">
    import { db } from "/js/firebase.js";
    import {
      doc, getDoc, collection, query, where, getDocs, addDoc, Timestamp, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firmId = new URLSearchParams(window.location.search).get("id");
    const userType = localStorage.getItem("userType");
    const userEmail = localStorage.getItem("userEmail");
    const loggedIn = localStorage.getItem("loggedIn");

    if (!loggedIn) {
      alert("DostÄ™p tylko dla zalogowanych uÅ¼ytkownikÃ³w ğŸ’");
      window.location.href = "/pages/login.html";
    }

    const firmName = document.getElementById("firmName");
    const firmBranch = document.getElementById("firmBranch");
    const firmLocation = document.getElementById("firmLocation");
    const firmAbout = document.getElementById("firmAbout");
    const firmSkills = document.getElementById("firmSkills");
    const projectsGrid = document.getElementById("projectsGrid");
    const projectsSection = document.getElementById("firmProjects");
    const avgRatingEl = document.getElementById("avgRating");
    const opinieList = document.getElementById("opinieList");
    const addOpinionBox = document.getElementById("addOpinionBox");
    const opinieAuthInfo = document.getElementById("opinieAuthInfo");

    async function loadFirm() {
      const ref = doc(db, "firmy", firmId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        firmName.textContent = "Nie znaleziono firmy";
        return;
      }
      const d = snap.data();
      firmName.textContent = d.nazwa || "Bez nazwy";
      firmBranch.textContent = d.branza || "";
      firmLocation.textContent = d.lokalizacja || "";
      firmAbout.textContent = d.opis || "";

      if (d.specjalizacje?.length) {
        document.querySelector(".profile-skills").style.display = "block";
        firmSkills.innerHTML = "";
        d.specjalizacje.forEach(s => {
          const li = document.createElement("li");
          li.textContent = s;
          firmSkills.appendChild(li);
        });
      }

      if (d.realizacje?.length) {
        projectsSection.style.display = "block";
        projectsGrid.innerHTML = "";
        d.realizacje.forEach(r => {
          const div = document.createElement("div");
          div.classList.add("project-card");
          if (r.typ === "zdjecie") {
            div.innerHTML = `<img src="${r.url}" alt=""><p>${r.opis || ""}</p>`;
          } else {
            div.innerHTML = `<iframe src="${r.url.replace("watch?v=", "embed/")}" allowfullscreen></iframe><p>${r.opis || ""}</p>`;
          }
          projectsGrid.appendChild(div);
        });
      }
      loadOpinie();
    }

    async function loadOpinie() {
      const q = query(collection(db, "opinie"), where("firmId", "==", firmId), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      opinieList.innerHTML = "";
      if (snap.empty) {
        opinieList.innerHTML = "<p>Brak opinii dla tej firmy ğŸ’</p>";
        avgRatingEl.textContent = "";
        return;
      }
      let total = 0;
      snap.forEach(d => total += d.data().ocena);
      const avg = (total / snap.size).toFixed(1);
      avgRatingEl.textContent = `ğŸ’ ${avg}`;
      snap.forEach(docSnap => {
        const o = docSnap.data();
        const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString("pl-PL") : "";
        let diamonds = "";
        for (let i = 1; i <= 5; i++) diamonds += i <= o.ocena ? "ğŸ’" : "â—‡";
        const div = document.createElement("div");
        div.classList.add("opinia-card");
        div.innerHTML = `<div class="row-head"><span class="gold">${diamonds}</span> <span class="muted">${dateStr}</span></div><p>${o.tresc || ""}</p>`;
        opinieList.appendChild(div);
      });
    }

    // Dodawanie opinii
    if (userType === "client") addOpinionBox.style.display = "block";
    else opinieAuthInfo.style.display = "block";

    const starsBox = document.getElementById("ratingStars");
    let selected = 0;
    for (let i = 1; i <= 5; i++) {
      const span = document.createElement("span");
      span.textContent = "ğŸ’";
      span.dataset.value = i;
      span.style.cursor = "pointer";
      span.onclick = () => {
        selected = i;
        starsBox.querySelectorAll("span").forEach(s => s.style.opacity = s.dataset.value <= i ? "1" : "0.3");
      };
      starsBox.appendChild(span);
    }

    document.getElementById("submitOpinion").addEventListener("click", async () => {
      if (selected === 0) return alert("Wybierz ocenÄ™ ğŸ’");
      const txt = document.getElementById("opiniaText").value.trim();
      if (!txt) return alert("Wpisz treÅ›Ä‡ opinii.");
      await addDoc(collection(db, "opinie"), {
        firmId,
        autorEmail: userEmail,
        ocena: selected,
        tresc: txt,
        createdAt: Timestamp.now()
      });
      alert("Twoja opinia zostaÅ‚a dodana ğŸ’");
      document.getElementById("opiniaText").value = "";
      selected = 0;
      starsBox.querySelectorAll("span").forEach(s => s.style.opacity = "1");
      loadOpinie();
    });

    loadFirm();
  </script>

  <style>
    .avg-rating{color:var(--gold);font-weight:600;}
    .opinia-card{background:#111;border-radius:10px;padding:12px;margin-bottom:12px;}
    .opinia-card .row-head{display:flex;justify-content:space-between;margin-bottom:6px;}
    .rating-diamonds span{font-size:22px;margin-right:4px;}
  </style>
</body>
</html>
